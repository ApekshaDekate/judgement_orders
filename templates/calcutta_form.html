<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calcutta High Court Search</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4">Calcutta High Court Case Search</h2>

    <!-- Search form -->
    <form id="searchForm">
      <div class="mb-3">
        <label for="order_establishment" class="form-label">Establishment</label>
        <select class="form-control form-control-sm" id="order_establishment" name="order_establishment" required>
          <option value="">Select</option>
          <option value="WBCHCA">Appellate Side</option>
          <option value="WBCHCO">Original Side</option>
          <option value="WBCHCJ">Circuit Bench Jalpaiguri</option>
          <option value="WBCHCP">Circuit Bench Portblair</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="caseType" class="form-label">Case Type</label>
        <select class="form-select" id="caseType" name="order_casetype" required>
          <option value="">-- Select Case Type --</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="order_reg_no" class="form-label">Registration No</label>
        <input type="text" class="form-control" id="order_reg_no" name="order_reg_no" required>
      </div>

      <div class="mb-3">
        <label for="order_year" class="form-label">Year</label>
        <input type="text" class="form-control" id="order_year" name="order_year" required>
      </div>

      <button type="submit" class="btn btn-primary">Search</button>
    </form>

    <div id="result" class="mt-4"></div>

    <!-- Results Table -->
    <div class="mt-4">
      <h4 id="caseTitle"></h4>
      <table class="table table-bordered" id="resultTable" style="display:none;">
        <thead>
          <tr>
            <th>#</th>
            <th>Date</th>
            <th>Judge</th>
            <th>Order</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="resultBody"></tbody>
      </table>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const estSelect = document.getElementById('order_establishment');
  const caseTypeSelect = document.getElementById('caseType');
  const form = document.getElementById('searchForm');
  const resultDiv = document.getElementById('result');

  // When establishment changes → fetch case types
  estSelect.addEventListener('change', async () => {
    const est = estSelect.value;
    caseTypeSelect.innerHTML = '<option value="">Loading…</option>';
    if (!est) return;

    try {
      const res = await fetch(`/case_types?est=${encodeURIComponent(est)}`);
      const data = await res.json();
      console.log("case_types response:", data); // debug

      caseTypeSelect.innerHTML = '<option value="">-- Select Case Type --</option>';

      // Ensure data is an array
      const items = Array.isArray(data) ? data : [data];

      items.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.case_type;             // numeric ID
        opt.textContent = item.full_form || item.type_name; // readable label
        caseTypeSelect.appendChild(opt);
      });

      if (items.length === 0) {
        caseTypeSelect.innerHTML = '<option value="">No case types found</option>';
      }

    } catch (err) {
      console.error(err);
      caseTypeSelect.innerHTML = '<option value="">Error loading case types</option>';
    }
  });

  // Submit search form
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    resultDiv.innerHTML = 'Loading…';

    const formData = new FormData(form);

    try {
      const res = await fetch('/calcutta', {
        method: 'POST',
        body: formData
      });

      if (res.headers.get('content-type')?.includes('application/json')) {
        const data = await res.json();
        resultDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      } else {
        const html = await res.text();
        resultDiv.innerHTML = html;
      }
    } catch (err) {
      console.error(err);
      resultDiv.textContent = 'Error fetching data';
    }
  });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
