<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Supreme Court Search</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    #results table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    #results th,
    #results td {
      border: 1px solid #dee2e6;
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }

    #results th {
      background-color: #f1f3f5;
      font-weight: 600;
    }

    #results a {
      color: #0d6efd;
      text-decoration: none;
    }

    #results a:hover {
      text-decoration: underline;
    }

    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, sans-serif;
    }

    .tab-content {
      margin-top: 20px;
    }

    .result-container {
      margin-top: 30px;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <div class="container mt-4">
    <h2 class="text-center mb-4">Supreme Court Search Portal</h2> <!-- Main Tabs -->
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation"> <button class="nav-link active" id="daily-tab" data-bs-toggle="tab"
          data-bs-target="#daily" type="button" role="tab">Daily Orders</button> </li>
      <li class="nav-item" role="presentation"> <button class="nav-link" id="judgement-tab" data-bs-toggle="tab"
          data-bs-target="#judgement" type="button" role="tab">Judgements</button> </li>
    </ul>
    <div class="tab-content" id="mainTabsContent"> <!-- ================= DAILY ORDERS TAB ================= -->
      <div class="tab-pane fade show active" id="daily" role="tabpanel">
        <ul class="nav nav-pills mt-3" id="dailySubTabs" role="tablist">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#daily-case">Case
              No.</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#daily-diary">Diary
              No.</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#daily-rop">ROP
              Date</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#daily-free">Free
              Text</button></li>
        </ul>
        <div class="tab-content mt-3"> <!-- Case No. -->
          <div class="tab-pane fade show active" id="daily-case">
            <form id="daily_orders/case_number-form" class="row g-3">
              <div class="col-md-4"> <label class="form-label">Case Type</label> <select name="case_type"
                  id="daily-case-type" class="form-select"></select> </div>
              <div class="col-md-4"> <label class="form-label">Case No.</label> <input type="text" name="case_no"
                  class="form-control" required> </div>
              <div class="col-md-4"> <label class="form-label">Year</label> <select id="daily-case-year" name="year"
                  class="form-select"></select> </div>
              <div class="col-12"><button class="btn btn-primary" type="submit">Search</button></div>
            </form>
          </div> <!-- Diary No. -->
          <div class="tab-pane fade" id="daily-diary">
            <form id="daily_orders/diary_number-form" class="row g-3">
              <div class="col-md-6"><label class="form-label">Diary No.</label><input type="text" name="diary_no"
                  class="form-control" required></div>
              <div class="col-md-6"><label class="form-label">Year</label><select id="daily-diary-year" name="year"
                  class="form-select"></select></div>
              <div class="col-12"><button class="btn btn-primary" type="submit">Search</button></div>
            </form>
          </div> <!-- ROP Date -->
          <div class="tab-pane fade" id="daily-rop">
            <form id="daily_orders/ROP_date-form" class="row g-3">
              <div class="col-md-6"><label class="form-label">From Date</label><input type="date" name="from_date"
                  class="form-control" required></div>
              <div class="col-md-6"><label class="form-label">To Date</label><input type="date" name="to_date"
                  class="form-control" required></div>
              <div class="col-12"><button class="btn btn-primary" type="submit">Search</button></div>
            </form>
          </div> <!-- Free Text -->
          <div class="tab-pane fade" id="daily-free">
            <form id="daily_orders/free_text-form" class="row g-3">
              <div class="col-md-4"><label class="form-label">Search Text</label><input type="text" name="search_text"
                  class="form-control" required></div>
              <div class="col-md-4"><label class="form-label">From Date</label><input type="date" name="from_date"
                  class="form-control"></div>
              <div class="col-md-4"><label class="form-label">To Date</label><input type="date" name="to_date"
                  class="form-control"></div>
              <div class="col-12"><button class="btn btn-primary" type="submit">Search</button></div>
            </form>
          </div>
        </div>
      </div> <!-- ================= JUDGEMENTS TAB ================= -->
      <div class="tab-pane fade" id="judgement" role="tabpanel">
        <ul class="nav nav-pills mt-3" id="judgementSubTabs" role="tablist">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill"
              data-bs-target="#judgement-case">Case No.</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#judgement-diary">Diary
              No.</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="pill"
              data-bs-target="#judgement-judge">Judge</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#judgement-date">Judgement
              Date</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#judgement-free">Free
              Text</button></li>
        </ul>
        <div class="tab-content mt-3"> <!-- Case No. -->
          <div class="tab-pane fade show active" id="judgement-case">
            <form id="judgements/case_number-form" class="row g-3">
              <div class="col-md-4"> <label class="form-label">Case Type</label> <select name="case_type"
                  id="judgement-case-type" class="form-select"></select> </div>
              <div class="col-md-4"><label class="form-label">Case No.</label><input type="text" name="case_no"
                  class="form-control" required></div>
              <div class="col-md-4"><label class="form-label">Year</label><select id="judgement-case-year" name="year"
                  class="form-select"></select></div>
              <div class="col-12"><button class="btn btn-primary" type="submit">Search</button></div>
            </form>
          </div> <!-- Diary No. -->
          <div class="tab-pane fade" id="judgement-diary">
            <form id="judgements/diary_number-form" class="row g-3">
              <div class="col-md-6"><label class="form-label">Diary No.</label><input type="text" name="diary_no"
                  class="form-control" required></div>
              <div class="col-md-6"><label class="form-label">Year</label><select id="judgement-diary-year" name="year"
                  class="form-select"></select></div>
              <div class="col-12"><button class="btn btn-primary" type="submit">Search</button></div>
            </form>
          </div> <!-- Judge -->
          <div class="tab-pane fade" id="judgement-judge">
            <form id="judgements/judge-form" class="row g-3">
              <div class="col-md-4"><label class="form-label">Judge Name</label><select name="judges"
                  id="judge-dropdown" class="form-select"></select></div>
              <div class="col-md-4"><label class="form-label">From Date</label><input type="date" name="from_date"
                  class="form-control"></div>
              <div class="col-md-4"><label class="form-label">To Date</label><input type="date" name="to_date"
                  class="form-control"></div>
              <div class="col-12"><button class="btn btn-primary" type="submit">Search</button></div>
            </form>
          </div> <!-- Judgement Date -->
          <div class="tab-pane fade" id="judgement-date">
            <form id="judgements/judgement_date-form" class="row g-3">
              <div class="col-md-6"><label class="form-label">From Date</label><input type="date" name="from_date"
                  class="form-control" required></div>
              <div class="col-md-6"><label class="form-label">To Date</label><input type="date" name="to_date"
                  class="form-control" required></div>
              <div class="col-12"><button class="btn btn-primary" type="submit">Search</button></div>
            </form>
          </div> <!-- Free Text -->
          <div class="tab-pane fade" id="judgement-free">
            <form id="judgements/free_text-form" class="row g-3">
              <div class="col-md-4"><label class="form-label">Search Text</label><input type="text" name="search_text"
                  class="form-control" required></div>
              <div class="col-md-4"><label class="form-label">From Date</label><input type="date" name="from_date"
                  class="form-control"></div>
              <div class="col-md-4"><label class="form-label">To Date</label><input type="date" name="to_date"
                  class="form-control"></div>
              <div class="col-12"><button class="btn btn-primary" type="submit">Search</button></div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div id="results" class="result-container" style="display:none;"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ðŸ§¹ Helper to clean and format HTML or escaped text
    function cleanHTML(raw) {
      if (!raw) return "";
      return raw
        .replace(/\\\//g, "/")           // unescape slashes
        .replace(/\\[nrt]/g, " ")        // remove escaped newlines/tabs
        .replace(/\\"/g, '"')            // fix quotes
        .replace(/<\/?script[^>]*>/gi, "") // remove scripts
        .replace(/&lt;/g, "<")
        .replace(/&gt;/g, ">")
        .replace(/&amp;/g, "&")
        .replace(/\\\//g, "/")
        .replace(/<\/?[^>]+>/g, " ")     // remove all HTML tags
        .replace(/\s{2,}/g, " ")         // collapse multiple spaces
        .trim();
    }

    async function loadDropdowns() {
      try {
        const res = await fetch("/case-details");
        const data = await res.json();
        const caseTypes = data.case_types || [];
        const years = data.case_years || [];

        const typeOptions = [`<option value="">--Select Case Type--</option>`]
          .concat(caseTypes.map(ct => `<option value="${ct.id}">${ct.name}</option>`))
          .join("");

        const yearOptions = [`<option value="">--Select Year--</option>`]
          .concat(years.map(y => `<option value="${y}">${y}</option>`))
          .join("");

        ["daily-case-type", "judgement-case-type"].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = typeOptions;
        });

        ["daily-case-year", "daily-diary-year", "judgement-case-year", "judgement-diary-year"].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = yearOptions;
        });

        const judgeRes = await fetch("/judges");
        const judgeData = await judgeRes.json();
        const judges = judgeData.judges || judgeData;
        const judgeOptions = [`<option value="">--Select Judge--</option>`]
          .concat(judges.map(j => `<option value="${j.id}">${j.name}</option>`))
          .join("");

        const judgeDropdown = document.getElementById("judge-dropdown");
        if (judgeDropdown) judgeDropdown.innerHTML = judgeOptions;
      } catch (err) {
        console.error("Error loading dropdowns:", err);
      }
    }

    loadDropdowns();

  document.querySelectorAll("form").forEach(form => {
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const params = new URLSearchParams();
    for (const [key, val] of formData.entries()) {
      if (val) params.append(key, val);
    }

    const endpoint = form.id.replace("-form", ""); // e.g. daily_orders/case_number
    const url = `/${endpoint}?${params.toString()}`;

    const results = document.getElementById("results");
    results.style.display = "block";
    results.innerHTML = "<p class='text-center text-muted'>Loading results...</p>";

    try {
      const res = await fetch(url);
      const data = await res.json();

      // ðŸ§© Handle nested structures safely
      let html = "";

      if (data.resultsHtml) {
        html = data.resultsHtml;
      } else if (data.data && data.data.resultsHtml) {
        html = data.data.resultsHtml;
      } else if (typeof data === "string") {
        html = data;
      } else if (data.html || data.table_html || data.result) {
        html = data.html || data.table_html || data.result;
      } else {
        // Fallback: pretty-print JSON for debugging
        html = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      }

      results.innerHTML = html;
    } catch (err) {
      results.innerHTML = `<p class='text-danger'>Error: ${err.message}</p>`;
    }
  });
});


  </script>
</body>

</html>